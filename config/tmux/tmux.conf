### Managed by the dotfiles repo

# --- TPM Plugins -------------------------------------------------------------
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.local/share/tmux/plugins"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @online_icon 'ok'
set -g @offline_icon 'nok'

# --- Theme --------------------------------
set -g @thm_bg "#1a1b26"
set -g @thm_fg "#c0caf5"

# Colors
set -g @thm_red "#f7768e"
set -g @thm_yellow "#e0af68"
set -g @thm_green "#9ece6a"
set -g @thm_blue "#7aa2f7"

# Surfaces and overlays
set -g @thm_subtext_1 "#a6adc8"
set -g @thm_subtext_0 "#bac2de"
set -g @thm_overlay_2 "#9399b2"
set -g @thm_overlay_1 "#7f849c"
set -g @thm_overlay_0 "#6c7086"
set -g @thm_surface_2 "#585b70"
set -g @thm_surface_1 "#45475a"
set -g @thm_surface_0 "#313244"
set -g @thm_mantle "#181825"
set -g @thm_crust "#11111b"

set -g window-status-activity-style "bg=#{@thm_blue},fg=#{@thm_crust}"
set -g window-status-bell-style "bg=#{@thm_yellow},fg=#{@thm_crust}"

# --- Core options ------------------------------------------------------------
set -g terminal-overrides ',*:Tc'
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'
set -g prefix C-a
unbind C-b
bind C-a send-prefix
set -g mouse on
set -g history-limit 10000
setw -g mode-keys vi
set -g status-position top
set -g status-style 'bg=#{@thm_bg}'
set -g status-justify 'absolute-centre'
set -gq allow-passthrough on  # allow escape sequences to pass through
set-option -g focus-events on # allow autoread to work in nvim
set -g detach-on-destroy off # don't exit tmux when losing session

# Pane border aesthetics
setw -g pane-border-status top
setw -g pane-border-format ''
setw -g pane-active-border-style 'bg=#{@thm_bg},fg=#{@thm_overlay_0}'
setw -g pane-border-style 'bg=#{@thm_bg},fg=#{@thm_surface_0}'
setw -g pane-border-lines single

# Window naming
set -wg automatic-rename on
set -g automatic-rename-format 'Window'
set -g window-status-format ' #I#{?#{!=:#{window_name},Window},: #W,} '
set -g window-status-style 'bg=#{@thm_bg},fg=#{@thm_text}'
set -g window-status-last-style 'bg=#{@thm_bg},fg=#{@thm_text}'
set -g window-status-activity-style 'bg=#{@thm_red},fg=#{@thm_bg}'
set -g window-status-bell-style 'bg=#{@thm_red},fg=#{@thm_bg},bold'
set -gF window-status-separator '#[bg=#{@thm_bg},fg=#{@thm_overlay_0}]‚îÇ'
set -g window-status-current-format ' #I#{?#{!=:#{window_name},Window},: #W,} '
set -g window-status-current-style 'bg=#{@thm_bg},fg=#{@thm_yellow},bold'

# Status left
set -g status-left-length 100
set -g status-left ''
set -ga status-left '#{?client_prefix,#{#[bg=#{@thm_red},fg=#{@thm_bg},bold] ÓØà #S },#{#[bg=#{@thm_bg},fg=#{@thm_green}] ÓØà #S }}'
set -ga status-left '#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]‚îÇ'
set -ga status-left '#[bg=#{@thm_bg},fg=#{@thm_red}] Ó™Ö #{pane_current_command} '
set -ga status-left '#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]‚îÇ'
set -ga status-left '#[bg=#{@thm_bg},fg=#{@thm_blue}] Ó´∑ #{=/-32/...:#{s|$USER|~|:#{b:pane_current_path}}} '
set -ga status-left '#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]#{?window_zoomed_flag,‚îÇ,}'
set -ga status-left '#[bg=#{@thm_bg},fg=#{@thm_yellow}]#{?window_zoomed_flag, Ó≠ø zoom ,}'

# Status right
set -g status-right-length 100
set -g status-right ''
set -ga status-right '#[bg=#{@thm_bg},fg=#{@thm_blue}] Û∞≠¶ %b %d '
set -ga status-right '#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none]‚îÇ'
set -ga status-right '#[bg=#{@thm_bg},fg=#{@thm_blue}] Û∞Öê %H:%M '
set -ga status-right '#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none]‚îÇ'
set -ga status-right '#[fg=#{@thm_bg}]#{continuum_status}' # for some reason this is needed for the following line to evaluate correctly
set -ga status-right '#{?#{e|>=:0,#{continuum_status}},#{#[bg=#{@thm_bg},fg=#{@thm_green}]}Û±£™ ,#{#[bg=#{@thm_bg},fg=#{@thm_red}]}Û±ôÉ }'

# Disable visual bell
set -g visual-bell off
set -g alternate-screen on

# Split panes preserving path
bind '\' split-window -h -c '#{pane_current_path}'
bind '-' split-window -v -c '#{pane_current_path}'

bind % split-window -h
bind '"' split-window -v
bind x kill-pane
bind o select-pane -t :.
bind q display-panes

# Pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window controls
bind c new-window
bind , command-prompt -I '#W' 'rename-window "%%"'
bind w choose-window
bind & kill-window

# Session controls
bind s choose-session
bind $ command-prompt -I '#S' 'rename-session "%%"'

# Reload config
unbind r
bind r source-file ~/.config/tmux/tmux.conf \; display-message 'Config reloaded!'
bind ? list-keys

# Copy mode (vi)
if-shell 'command -v pbcopy >/dev/null 2>&1' \
  'set -g @system_copy "pbcopy"' \
  'if-shell "command -v wl-copy >/dev/null 2>&1" "set -g @system_copy \"wl-copy\"" "if-shell \"command -v xclip >/dev/null 2>&1\" \"set -g @system_copy \\\"xclip -selection clipboard\\\"\" \"set -g @system_copy \\\"\\\"\""'

bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line
bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel "#{@system_copy}"
bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "#{@system_copy}"
bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "#{@system_copy}"

if -F '#{==:#{@system_copy},}' 'display-message "Install pbcopy (macOS), wl-copy (Wayland), or xclip (X11) for clipboard sync"'

# Sesh selection

# always switch the client to the second to last session that has been attached
bind -N "last-session (via sesh) " L run-shell "sesh last"
bind-key "k" run-shell "sesh connect \"$(
  sesh list -i | awk 'tolower($0) !~ /opencode/' | fzf-tmux -p 55%,60% \
    --ansi --no-sort --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  ^a all ^t tmux ^x zoxide ^g config ^d tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind "ctrl-a:change-prompt(‚ö°  )+reload(sesh list -i | awk 'tolower(\$0) !~ /opencode/')" \
    --bind "ctrl-t:change-prompt(ü™ü  )+reload(sesh list -it | awk 'tolower(\$0) !~ /opencode/')" \
    --bind "ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -ic | awk 'tolower(\$0) !~ /opencode/')" \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -iz)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind "ctrl-d:execute(tmux kill-session -t {})+change-prompt(‚ö°  )+reload(sesh list | awk 'tolower(\$0) !~ /opencode/')"
)\""

# Keep Kitty transparency visible inside panes
set -g window-style 'bg=default'
set -g window-active-style 'bg=default'
set -g mode-style 'fg=#cdd6f4,bg=default,bold'

# Save/restore sessions automatically
set -g @resurrect-dir '~/.local/state/tmux/resurrect'
# Causes ressurect to fail to save state
# set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '5'
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'kitty'

# Finalize TPM
run '~/.local/share/tmux/plugins/tpm/tpm'
